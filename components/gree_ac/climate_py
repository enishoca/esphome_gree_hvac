"""Climate platform for Gree AC."""
import esphome.codegen as cg
import esphome.config_validation as cv
from esphome.components import climate, uart, sensor, select, switch as switch_
from esphome.const import (
    CONF_ID,
    CONF_SUPPORTED_PRESETS,
)
from esphome.components.climate import ClimatePreset
from . import gree_ac_ns, GreeAC, GreeACSwitch, GreeACSelect

# Configuration keys
CONF_HORIZONTAL_SWING_SELECT = "horizontal_swing_select"
CONF_VERTICAL_SWING_SELECT = "vertical_swing_select"
CONF_DISPLAY_SELECT = "display_select"
CONF_PLASMA_SWITCH = "plasma_switch"
CONF_SLEEP_SWITCH = "sleep_switch"
CONF_XFAN_SWITCH = "xfan_switch"
CONF_CURRENT_TEMPERATURE_SENSOR = "current_temperature_sensor"

# Swing options - must match C++ constants
HORIZONTAL_SWING_OPTIONS = [
    "Off",
    "Full Swing",
    "Left",
    "Mid-Left",
    "Center",
    "Mid-Right",
    "Right",
]

VERTICAL_SWING_OPTIONS = [
    "Off",
    "Full Swing",
    "Up",
    "Mid-Up",
    "Center",
    "Mid-Down",
    "Down",
]

DISPLAY_OPTIONS = [
    "Off",
    "On",
]

# Presets
ALLOWED_CLIMATE_PRESETS = {
    "NONE": ClimatePreset.CLIMATE_PRESET_NONE,
    "BOOST": ClimatePreset.CLIMATE_PRESET_BOOST,
}

validate_presets = cv.enum(ALLOWED_CLIMATE_PRESETS, upper=True)

# Schema definitions
switch_schema = switch_.switch_schema(GreeACSwitch).extend(cv.COMPONENT_SCHEMA)
select_schema = select.select_schema(GreeACSelect).extend(cv.COMPONENT_SCHEMA)

CONFIG_SCHEMA = cv.All(
    climate.CLIMATE_SCHEMA.extend(
        {
            cv.GenerateID(): cv.declare_id(GreeAC),
            cv.Optional(CONF_HORIZONTAL_SWING_SELECT): select_schema,
            cv.Optional(CONF_VERTICAL_SWING_SELECT): select_schema,
            cv.Optional(CONF_DISPLAY_SELECT): select_schema,
            cv.Optional(CONF_PLASMA_SWITCH): switch_schema,
            cv.Optional(CONF_SLEEP_SWITCH): switch_schema,
            cv.Optional(CONF_XFAN_SWITCH): switch_schema,
            cv.Optional(CONF_CURRENT_TEMPERATURE_SENSOR): cv.use_id(sensor.Sensor),
            cv.Optional(CONF_SUPPORTED_PRESETS): cv.ensure_list(validate_presets),
        }
    )
    .extend(cv.polling_component_schema("1s"))
    .extend(uart.UART_DEVICE_SCHEMA)
)


async def to_code(config):
    """Generate C++ code from config."""
    var = cg.new_Pvariable(config[CONF_ID])
    await cg.register_component(var, config)
    await climate.register_climate(var, config)
    await uart.register_uart_device(var, config)

    # Horizontal swing select
    if CONF_HORIZONTAL_SWING_SELECT in config:
        conf = config[CONF_HORIZONTAL_SWING_SELECT]
        hswing_select = await select.new_select(conf, options=HORIZONTAL_SWING_OPTIONS)
        await cg.register_component(hswing_select, conf)
        cg.add(var.set_horizontal_swing_select(hswing_select))

    # Vertical swing select
    if CONF_VERTICAL_SWING_SELECT in config:
        conf = config[CONF_VERTICAL_SWING_SELECT]
        vswing_select = await select.new_select(conf, options=VERTICAL_SWING_OPTIONS)
        await cg.register_component(vswing_select, conf)
        cg.add(var.set_vertical_swing_select(vswing_select))

    # Display select
    if CONF_DISPLAY_SELECT in config:
        conf = config[CONF_DISPLAY_SELECT]
        display_select = await select.new_select(conf, options=DISPLAY_OPTIONS)
        await cg.register_component(display_select, conf)
        cg.add(var.set_display_select(display_select))

    # External temperature sensor
    if CONF_CURRENT_TEMPERATURE_SENSOR in config:
        sens = await cg.get_variable(config[CONF_CURRENT_TEMPERATURE_SENSOR])
        cg.add(var.set_current_temperature_sensor(sens))

    # Switches (Plasma, Sleep, X-Fan)
    for switch_key in [CONF_PLASMA_SWITCH, CONF_SLEEP_SWITCH, CONF_XFAN_SWITCH]:
        if switch_key in config:
            conf = config[switch_key]
            sw = cg.new_Pvariable(conf[CONF_ID])
            await cg.register_component(sw, conf)
            await switch_.register_switch(sw, conf)
            cg.add(getattr(var, f"set_{switch_key}")(sw))

    # Supported presets
    if CONF_SUPPORTED_PRESETS in config:
        cg.add(var.set_supported_presets(config[CONF_SUPPORTED_PRESETS]))
